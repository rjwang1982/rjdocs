# Aurora è“ç»¿éƒ¨ç½²åˆ‡æ¢å‰æ£€æŸ¥è„šæœ¬

å®Œæ•´çš„ Aurora è“ç»¿éƒ¨ç½²åˆ‡æ¢å‰æ£€æŸ¥å·¥å…·ï¼ŒéªŒè¯æ‰€æœ‰å…³é”®æŒ‡æ ‡æ˜¯å¦æ»¡è¶³åˆ‡æ¢æ¡ä»¶ã€‚

## åŠŸèƒ½ç‰¹æ€§

### AWS å±‚é¢æ£€æŸ¥
- âœ… è“ç»¿éƒ¨ç½²çŠ¶æ€éªŒè¯
- âœ… é›†ç¾¤å¥åº·çŠ¶æ€æ£€æŸ¥
- âœ… CloudWatch æŒ‡æ ‡ç›‘æ§ï¼ˆè¿æ¥æ•°ã€CPUã€IOPSï¼‰
- âœ… å¤åˆ¶å»¶è¿Ÿæ£€æŸ¥

### æ•°æ®åº“å±‚é¢æ£€æŸ¥
- âœ… é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡æ£€æµ‹ï¼ˆè“è‰²ç¯å¢ƒï¼‰
- âœ… é”ç­‰å¾…åˆ†æï¼ˆè“è‰²ç¯å¢ƒï¼‰
- âœ… æ´»è·ƒè¿æ¥ç»Ÿè®¡ï¼ˆè“è‰²ç¯å¢ƒï¼‰
- âœ… DDL æ“ä½œæ£€æµ‹ï¼ˆè“è‰²ç¯å¢ƒï¼‰
- âœ… å¤åˆ¶çŠ¶æ€éªŒè¯ï¼ˆç»¿è‰²ç¯å¢ƒï¼‰

### è¾“å‡ºç‰¹æ€§
- ğŸ¨ å½©è‰²è¾“å‡ºï¼Œæ˜“äºé˜…è¯»
- ğŸ“Š è¯¦ç»†çš„æ£€æŸ¥æŠ¥å‘Š
- ğŸ’¡ æ™ºèƒ½åˆ‡æ¢å»ºè®®
- âš¡ è‡ªåŠ¨ç”Ÿæˆåˆ‡æ¢å‘½ä»¤

## å‰ç½®è¦æ±‚

### å¿…éœ€å·¥å…·
```bash
# å®‰è£… AWS CLI
brew install awscli

# å®‰è£… MySQL å®¢æˆ·ç«¯
brew install mysql-client

# å®‰è£… jqï¼ˆJSON å¤„ç†ï¼‰
brew install jq

# bc é€šå¸¸å·²é¢„è£…åœ¨ macOS
```

### AWS æƒé™
éœ€è¦ä»¥ä¸‹ IAM æƒé™ï¼š
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "rds:DescribeBlueGreenDeployments",
        "rds:DescribeDBClusters",
        "cloudwatch:GetMetricStatistics"
      ],
      "Resource": "*"
    }
  ]
}
```

### æ•°æ®åº“æƒé™
éœ€è¦ä»¥ä¸‹æ•°æ®åº“æƒé™ï¼š
```sql
GRANT PROCESS, REPLICATION CLIENT ON *.* TO 'check_user'@'%';
```

## ä½¿ç”¨æ–¹æ³•

### 1. é…ç½®è„šæœ¬

ç¼–è¾‘è„šæœ¬å¤´éƒ¨çš„é…ç½®å‚æ•°ï¼š

```bash
vim aurora-bg-switchover-check.sh
```

ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

```bash
#############################################
# é…ç½®å‚æ•° - è¯·åœ¨æ­¤å¤„ä¿®æ”¹
#############################################

# AWS é…ç½®
BG_DEPLOYMENT_ID="bgd-xxxxxxxxxxxxx"           # è“ç»¿éƒ¨ç½² ID
DB_CLUSTER_ID="my-aurora-cluster"              # é›†ç¾¤æ ‡è¯†ç¬¦
AWS_REGION="us-east-1"                         # AWS åŒºåŸŸ

# è“è‰²ç¯å¢ƒï¼ˆå½“å‰ç”Ÿäº§ç¯å¢ƒï¼‰æ•°æ®åº“è¿æ¥
BLUE_DB_HOST="blue-cluster.cluster-xxxxx.us-east-1.rds.amazonaws.com"
BLUE_DB_USER="admin"
BLUE_DB_PASSWORD="your-blue-password"

# ç»¿è‰²ç¯å¢ƒï¼ˆæ–°ç¯å¢ƒï¼‰æ•°æ®åº“è¿æ¥
GREEN_DB_HOST="green-cluster.cluster-xxxxx.us-east-1.rds.amazonaws.com"
GREEN_DB_USER="admin"
GREEN_DB_PASSWORD="your-green-password"

# æ£€æŸ¥é˜ˆå€¼é…ç½®
MAX_CONNECTIONS=100                            # æœ€å¤§è¿æ¥æ•°
MAX_REPLICATION_LAG_SECONDS=1                  # æœ€å¤§å¤åˆ¶å»¶è¿Ÿï¼ˆç§’ï¼‰
MAX_LONG_TRANSACTION_SECONDS=10                # é•¿äº‹åŠ¡é˜ˆå€¼ï¼ˆç§’ï¼‰
MAX_LOCK_WAIT_SECONDS=5                        # é”ç­‰å¾…é˜ˆå€¼ï¼ˆç§’ï¼‰
```

### 2. è¿è¡Œæ£€æŸ¥

```bash
# ç›´æ¥è¿è¡Œ
./aurora-bg-switchover-check.sh

# æˆ–ä¿å­˜æ—¥å¿—
./aurora-bg-switchover-check.sh | tee check-$(date +%Y%m%d-%H%M%S).log
```

### 3. è·å–é…ç½®ä¿¡æ¯

#### è·å–è“ç»¿éƒ¨ç½² ID

```bash
# åˆ—å‡ºæ‰€æœ‰è“ç»¿éƒ¨ç½²
aws rds describe-blue-green-deployments --region us-east-1

# è·å–ç‰¹å®šé›†ç¾¤çš„è“ç»¿éƒ¨ç½²
aws rds describe-blue-green-deployments \
    --region us-east-1 \
    --query "BlueGreenDeployments[?contains(Source, 'my-cluster')].BlueGreenDeploymentIdentifier" \
    --output text
```

#### è·å–æ•°æ®åº“ç«¯ç‚¹

```bash
# è·å–è“è‰²ç¯å¢ƒç«¯ç‚¹
aws rds describe-blue-green-deployments \
    --blue-green-deployment-identifier bgd-xxxxxxxxxxxxx \
    --region us-east-1 \
    --query 'BlueGreenDeployments[0].Source' \
    --output text

# è·å–ç»¿è‰²ç¯å¢ƒç«¯ç‚¹
aws rds describe-blue-green-deployments \
    --blue-green-deployment-identifier bgd-xxxxxxxxxxxxx \
    --region us-east-1 \
    --query 'BlueGreenDeployments[0].Target' \
    --output text
```

## è¾“å‡ºç¤ºä¾‹

### æˆåŠŸåœºæ™¯

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Aurora è“ç»¿éƒ¨ç½²åˆ‡æ¢å‰æ£€æŸ¥è„šæœ¬                       â•‘
â•‘   æ£€æŸ¥æ—¶é—´: 2025-10-27 14:55:00                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

========================================
æ£€æŸ¥å‰ç½®æ¡ä»¶
========================================
âœ“ å‘½ä»¤ aws å·²å®‰è£…
âœ“ å‘½ä»¤ mysql å·²å®‰è£…
âœ“ å‘½ä»¤ jq å·²å®‰è£…
âœ“ å‘½ä»¤ bc å·²å®‰è£…

========================================
æ£€æŸ¥è“ç»¿éƒ¨ç½²çŠ¶æ€
========================================
â„¹ è“ç»¿éƒ¨ç½²çŠ¶æ€: AVAILABLE
âœ“ è“ç»¿éƒ¨ç½²çŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥åˆ‡æ¢

========================================
æ£€æŸ¥é›†ç¾¤çŠ¶æ€
========================================
â„¹ é›†ç¾¤çŠ¶æ€: available
âœ“ é›†ç¾¤çŠ¶æ€æ­£å¸¸

========================================
æ£€æŸ¥ CloudWatch æŒ‡æ ‡
========================================
â„¹ æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°ï¼ˆæœ€è¿‘ 5 åˆ†é’Ÿå¹³å‡å€¼ï¼‰...
â„¹ å½“å‰å¹³å‡è¿æ¥æ•°: 45
âœ“ è¿æ¥æ•°åœ¨å®‰å…¨èŒƒå›´å†… (< 100)
â„¹ æ£€æŸ¥ CPU ä½¿ç”¨ç‡...
â„¹ å½“å‰ CPU ä½¿ç”¨ç‡: 35.50%
âœ“ CPU ä½¿ç”¨ç‡æ­£å¸¸ (< 70%)

========================================
æ£€æŸ¥é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
========================================
âœ“ æ²¡æœ‰é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ (> 10s)

========================================
æ£€æŸ¥é”ç­‰å¾…
========================================
âœ“ æ²¡æœ‰é”ç­‰å¾… (> 5s)

========================================
æ£€æŸ¥ç»“æœæ±‡æ€»
========================================

æ€»è®¡æ£€æŸ¥é¡¹:
  é€šè¿‡: 12
  å¤±è´¥: 0
  è­¦å‘Š: 0

åˆ‡æ¢å»ºè®®:
âœ“ æ‰€æœ‰å…³é”®æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å®‰å…¨æ‰§è¡Œåˆ‡æ¢

æ‰§è¡Œåˆ‡æ¢å‘½ä»¤:
aws rds switchover-blue-green-deployment \
    --blue-green-deployment-identifier bgd-xxxxxxxxxxxxx \
    --switchover-timeout 300 \
    --region us-east-1

æ£€æŸ¥å®Œæˆï¼
```

### å¤±è´¥åœºæ™¯

```
========================================
æ£€æŸ¥é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
========================================
âœ— å‘ç°é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡:
  - ID: 12345, ç”¨æˆ·: app_user, æ—¶é—´: 45s, çŠ¶æ€: updating
    æŸ¥è¯¢: UPDATE orders SET status = 'processed' WHERE...
â„¹ å»ºè®®ç»ˆæ­¢è¿™äº›äº‹åŠ¡: KILL <process_id>;

========================================
æ£€æŸ¥é”ç­‰å¾…
========================================
âœ— å‘ç°é”ç­‰å¾…:
  - ç­‰å¾…çº¿ç¨‹: 67890, é˜»å¡çº¿ç¨‹: 12345, ç­‰å¾…æ—¶é—´: 8s
â„¹ å»ºè®®ç»ˆæ­¢é˜»å¡çº¿ç¨‹

========================================
æ£€æŸ¥ç»“æœæ±‡æ€»
========================================

æ€»è®¡æ£€æŸ¥é¡¹:
  é€šè¿‡: 8
  å¤±è´¥: 3
  è­¦å‘Š: 1

åˆ‡æ¢å»ºè®®:
âœ— å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼Œä¸å»ºè®®ç«‹å³åˆ‡æ¢

å»ºè®®æ“ä½œ:
  1. è§£å†³ä¸Šè¿°å¤±è´¥çš„æ£€æŸ¥é¡¹
  2. ç­‰å¾…ç³»ç»Ÿè´Ÿè½½é™ä½
  3. ç»ˆæ­¢é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
  4. é€‰æ‹©æ›´ä½å³°çš„æ—¶æ®µ
```

## æ£€æŸ¥é¡¹è¯´æ˜

### 1. è“ç»¿éƒ¨ç½²çŠ¶æ€
- **æ£€æŸ¥å†…å®¹**: éªŒè¯è“ç»¿éƒ¨ç½²æ˜¯å¦å¤„äº AVAILABLE çŠ¶æ€
- **å¤±è´¥å½±å“**: æ— æ³•æ‰§è¡Œåˆ‡æ¢
- **è§£å†³æ–¹æ³•**: ç­‰å¾…éƒ¨ç½²å®Œæˆæˆ–æ£€æŸ¥éƒ¨ç½²é”™è¯¯

### 2. é›†ç¾¤çŠ¶æ€
- **æ£€æŸ¥å†…å®¹**: éªŒè¯ Aurora é›†ç¾¤æ˜¯å¦å¥åº·
- **å¤±è´¥å½±å“**: åˆ‡æ¢å¯èƒ½å¤±è´¥
- **è§£å†³æ–¹æ³•**: æ£€æŸ¥é›†ç¾¤äº‹ä»¶æ—¥å¿—

### 3. è¿æ¥æ•°
- **æ£€æŸ¥å†…å®¹**: å½“å‰æ´»è·ƒè¿æ¥æ•°
- **é˜ˆå€¼**: < 100ï¼ˆå¯é…ç½®ï¼‰
- **å¤±è´¥å½±å“**: åˆ‡æ¢æ—¶é—´å»¶é•¿
- **è§£å†³æ–¹æ³•**: ç­‰å¾…è¿æ¥æ•°é™ä½æˆ–é€‰æ‹©ä½å³°æ—¶æ®µ

### 4. CPU ä½¿ç”¨ç‡
- **æ£€æŸ¥å†…å®¹**: é›†ç¾¤ CPU è´Ÿè½½
- **é˜ˆå€¼**: < 70%
- **å¤±è´¥å½±å“**: åˆ‡æ¢æœŸé—´æ€§èƒ½ä¸‹é™
- **è§£å†³æ–¹æ³•**: ç­‰å¾…è´Ÿè½½é™ä½

### 5. é•¿äº‹åŠ¡
- **æ£€æŸ¥å†…å®¹**: è¿è¡Œæ—¶é—´ > 10 ç§’çš„äº‹åŠ¡
- **å¤±è´¥å½±å“**: åˆ‡æ¢ç­‰å¾…æ—¶é—´å»¶é•¿ï¼Œå¯èƒ½è¶…æ—¶
- **è§£å†³æ–¹æ³•**: ç»ˆæ­¢é•¿äº‹åŠ¡æˆ–ç­‰å¾…å…¶å®Œæˆ

### 6. é”ç­‰å¾…
- **æ£€æŸ¥å†…å®¹**: ç­‰å¾…æ—¶é—´ > 5 ç§’çš„é”
- **å¤±è´¥å½±å“**: åˆ‡æ¢å¯èƒ½è¶…æ—¶å¤±è´¥
- **è§£å†³æ–¹æ³•**: ç»ˆæ­¢é˜»å¡äº‹åŠ¡

### 7. å¤åˆ¶å»¶è¿Ÿ
- **æ£€æŸ¥å†…å®¹**: è“è‰²åˆ°ç»¿è‰²çš„å¤åˆ¶å»¶è¿Ÿ
- **é˜ˆå€¼**: < 1 ç§’
- **å¤±è´¥å½±å“**: æ•°æ®ä¸ä¸€è‡´é£é™©
- **è§£å†³æ–¹æ³•**: ç­‰å¾…å¤åˆ¶è¿½ä¸Šæˆ–é™ä½å†™å…¥è´Ÿè½½

### 8. DDL æ“ä½œ
- **æ£€æŸ¥å†…å®¹**: æ­£åœ¨æ‰§è¡Œçš„è¡¨ç»“æ„å˜æ›´
- **å¤±è´¥å½±å“**: åˆ‡æ¢ä¸¥é‡å»¶è¿Ÿæˆ–å¤±è´¥
- **è§£å†³æ–¹æ³•**: ç­‰å¾… DDL å®Œæˆæˆ–å–æ¶ˆæ“ä½œ

## é€€å‡ºç 

- `0`: æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å®‰å…¨åˆ‡æ¢
- `1`: å­˜åœ¨è­¦å‘Šï¼Œå»ºè®®è¯„ä¼°ååˆ‡æ¢
- `2`: å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼Œä¸å»ºè®®åˆ‡æ¢

## é›†æˆåˆ° CI/CD

### åœ¨åˆ‡æ¢å‰è‡ªåŠ¨æ£€æŸ¥

```bash
#!/bin/bash

# è¿è¡Œæ£€æŸ¥
./aurora-bg-switchover-check.sh

# æ ¹æ®é€€å‡ºç å†³å®šæ˜¯å¦ç»§ç»­
if [ $? -eq 0 ]; then
    echo "æ£€æŸ¥é€šè¿‡ï¼Œæ‰§è¡Œåˆ‡æ¢..."
    aws rds switchover-blue-green-deployment \
        --blue-green-deployment-identifier "$BG_DEPLOYMENT_ID" \
        --switchover-timeout 300
else
    echo "æ£€æŸ¥å¤±è´¥ï¼Œå–æ¶ˆåˆ‡æ¢"
    exit 1
fi
```

### å®šæ—¶ç›‘æ§

```bash
# æ·»åŠ åˆ° crontabï¼Œæ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * /path/to/aurora-bg-switchover-check.sh >> /var/log/aurora-check.log 2>&1
```

## æ•…éšœæ’æŸ¥

### æ— æ³•è¿æ¥ AWS
```bash
# æ£€æŸ¥ AWS å‡­è¯
aws sts get-caller-identity

# æ£€æŸ¥åŒºåŸŸè®¾ç½®
echo $AWS_REGION
```

### æ— æ³•è¿æ¥æ•°æ®åº“
```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" -e "SELECT 1;"

# æ£€æŸ¥å®‰å…¨ç»„è§„åˆ™
aws ec2 describe-security-groups --group-ids sg-xxxxx
```

### CloudWatch æŒ‡æ ‡ä¸ºç©º
```bash
# ç¡®è®¤æŒ‡æ ‡å­˜åœ¨
aws cloudwatch list-metrics \
    --namespace AWS/RDS \
    --dimensions Name=DBClusterIdentifier,Value="$DB_CLUSTER_ID"
```

## æœ€ä½³å®è·µ

1. **åˆ‡æ¢å‰ 30 åˆ†é’Ÿè¿è¡Œæ£€æŸ¥**
   - æå‰å‘ç°é—®é¢˜
   - æœ‰æ—¶é—´è§£å†³å¼‚å¸¸

2. **åœ¨ä½å³°æ—¶æ®µåˆ‡æ¢**
   - å‡Œæ™¨ 2-4 ç‚¹
   - å‘¨æœ«æˆ–èŠ‚å‡æ—¥

3. **ä¿ç•™æ£€æŸ¥æ—¥å¿—**
   ```bash
   ./aurora-bg-switchover-check.sh | tee check-$(date +%Y%m%d-%H%M%S).log
   ```

4. **è®¾ç½®å‘Šè­¦**
   - åˆ‡æ¢å¤±è´¥æ—¶å‘é€é€šçŸ¥
   - ç›‘æ§åˆ‡æ¢åçš„æ€§èƒ½æŒ‡æ ‡

5. **å‡†å¤‡å›æ»šè®¡åˆ’**
   - ä¿ç•™è“ç»¿éƒ¨ç½²è‡³å°‘ 24 å°æ—¶
   - è®°å½•åˆ‡æ¢å‰çš„é…ç½®

## å®‰å…¨æ³¨æ„äº‹é¡¹

âš ï¸ **å¯†ç å®‰å…¨**

è„šæœ¬ä¸­åŒ…å«æ•°æ®åº“å¯†ç ï¼Œè¯·æ³¨æ„ä»¥ä¸‹å®‰å…¨æªæ–½ï¼š

### 1. æ–‡ä»¶æƒé™ä¿æŠ¤

```bash
# è®¾ç½®è„šæœ¬ä¸ºä»…æ‰€æœ‰è€…å¯è¯»å†™
chmod 700 aurora-bg-switchover-check.sh

# éªŒè¯æƒé™
ls -l aurora-bg-switchover-check.sh
# åº”æ˜¾ç¤º: -rwx------ 1 user group ...
```

### 2. ä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶

```bash
# æ·»åŠ åˆ° .gitignore
echo "aurora-bg-switchover-check.sh" >> .gitignore

# æˆ–åˆ›å»ºé…ç½®æ¨¡æ¿
cp aurora-bg-switchover-check.sh aurora-bg-switchover-check.sh.template

# åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨å ä½ç¬¦
BLUE_DB_PASSWORD="REPLACE_WITH_YOUR_PASSWORD"
```

### 3. ä½¿ç”¨ AWS Secrets Managerï¼ˆæ¨èï¼‰

ä¿®æ”¹è„šæœ¬ä½¿ç”¨ Secrets Managerï¼š

```bash
# åœ¨è„šæœ¬é…ç½®éƒ¨åˆ†æ·»åŠ 
BLUE_DB_PASSWORD=$(aws secretsmanager get-secret-value \
    --secret-id aurora-blue-password \
    --region us-east-1 \
    --query SecretString \
    --output text | jq -r .password)

GREEN_DB_PASSWORD=$(aws secretsmanager get-secret-value \
    --secret-id aurora-green-password \
    --region us-east-1 \
    --query SecretString \
    --output text | jq -r .password)
```

### 4. ä½¿ç”¨åªè¯»è´¦å·

ä¸ºæ£€æŸ¥è„šæœ¬åˆ›å»ºä¸“ç”¨çš„åªè¯»è´¦å·ï¼š

```sql
-- åˆ›å»ºåªè¯»æ£€æŸ¥è´¦å·
CREATE USER 'check_user'@'%' IDENTIFIED BY 'secure_password';

-- æˆäºˆæœ€å°æƒé™
GRANT PROCESS, REPLICATION CLIENT ON *.* TO 'check_user'@'%';

-- éªŒè¯æƒé™
SHOW GRANTS FOR 'check_user'@'%';
```

### 5. å®šæœŸè½®æ¢å¯†ç 

```bash
# æ›´æ–° Secrets Manager ä¸­çš„å¯†ç 
aws secretsmanager update-secret \
    --secret-id aurora-blue-password \
    --secret-string '{"password":"new_secure_password"}'
```

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
